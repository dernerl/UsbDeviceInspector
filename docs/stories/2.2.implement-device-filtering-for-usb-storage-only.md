# Story 2.2: Implement Device Filtering for USB Storage Only

<!-- Powered by BMAD Core -->

## Status

**Done**

## Story

**As a** developer,
**I want** device enumeration to filter out internal SD card readers and non-USB storage devices,
**so that** users only see relevant removable USB storage devices (per FR5).

## Acceptance Criteria

1. Device selector uses Advanced Query Syntax (AQS) to filter for USB interface devices
2. Filtering logic excludes devices with SystemDeviceID containing "SD" or "MMC" patterns
3. Filtering logic verifies device connection type is USB (not internal SATA/PCIe)
4. Service method returns only USB storage devices (flash drives, external HDDs, USB-connected card readers)
5. Unit tests validate filtering logic with mock device collections containing:
   - USB flash drives (should be included)
   - Internal SD card readers (should be excluded)
   - USB-connected card readers (should be included)
   - Internal SSDs (should be excluded)
6. Manual testing with 3+ physical device types validates filtering behavior
7. Console logging (Debug output) shows filtered device count for troubleshooting

## Tasks / Subtasks

- [x] Research and implement AQS device selector (AC: 1)
  - [x] Investigate `DeviceInformation.CreateWatcher()` or `FindAllAsync()` with AQS filter string
  - [x] Create `GetDeviceSelector()` method returning AQS string targeting USB interface devices
  - [x] Update `EnumerateDevicesAsync()` to use the AQS selector instead of `DeviceClass.PortableStorageDevice`
  - [x] Request additional properties needed for filtering: `System.Devices.DeviceInstanceId`, `System.Devices.InterfaceClassGuid`

- [x] Implement SD/MMC filtering logic (AC: 2)
  - [x] Add private method `IsInternalSdCardReader(DeviceInformation device)`
  - [x] Check `DeviceInstanceId` (Device Instance Path) for "SD" or "MMC" patterns
  - [x] Consider patterns like `SD\`, `SDBUS\`, `MMC\` in the Device Instance Path prefix

- [x] Implement USB connection type verification (AC: 3)
  - [x] Add private method `IsUsbConnectedDevice(DeviceInformation device)`
  - [x] Verify Device Instance Path starts with `USB\` prefix
  - [x] Exclude paths starting with `SATA\`, `PCIE\`, `NVME\`, `IDE\`

- [x] Create combined filtering method (AC: 4)
  - [x] Add private method `FilterUsbStorageDevices(IEnumerable<DeviceInformation> devices)`
  - [x] Apply both SD/MMC filter and USB connection verification
  - [x] Return filtered collection of USB-only devices
  - [x] Add `Debug.WriteLine` logging showing original count vs filtered count (AC: 7)

- [x] Update `EnumerateDevicesAsync()` to apply filtering (AC: 4)
  - [x] Call `FilterUsbStorageDevices()` on enumerated devices before returning
  - [x] Maintain async/await pattern (no blocking)

- [x] Create unit tests for filtering logic (AC: 5)
  - [x] Create test file `DeviceEnumerationServiceFilteringTests.cs` in test project
  - [x] Test: USB flash drive device path is included (e.g., `USB\VID_0781&PID_5581\serial`)
  - [x] Test: Internal SD card reader is excluded (e.g., `SD\DISK&...` or containing `\SD\`)
  - [x] Test: USB-connected card reader is included (USB prefix with card reader properties)
  - [x] Test: Internal SSD is excluded (SATA/NVME prefix)
  - [x] Test: Empty collection returns empty (not null)
  - [x] Test: Collection with mixed devices filters correctly

- [x] Add XML documentation to new methods (AC: 1, 2, 3, 4)
  - [x] Document `GetDeviceSelector()` method
  - [x] Document `IsInternalSdCardReader()` method
  - [x] Document `IsUsbConnectedDevice()` method
  - [x] Document `FilterUsbStorageDevices()` method

- [ ] Manual validation (AC: 6)
  - [x] Build and run application
  - [ ] Test with USB flash drive (should appear)
  - [ ] Test with built-in SD card reader if available (should NOT appear)
  - [ ] Test with external USB card reader if available (should appear)
  - [x] Document validation results in completion notes

## Dev Notes

### Previous Story Insights

**Source:** [Story 2.1 Dev Agent Record]

- **CRITICAL:** Platform must be `x64` for all build/test commands - WinUI3 doesn't support AnyCPU
- Build command: `dotnet build -p:Platform=x64`
- Test command: `dotnet test -p:Platform=x64`
- Windows App SDK version: **1.8.250907003**
- Current build: **0 errors, 0 warnings**
- Current tests: **4/4 passing**
- DI container setup complete in `App.xaml.cs` with `IServiceProvider` exposed via `App.Current.Services`
- `DeviceEnumerationService` currently uses `DeviceInformation.FindAllAsync(DeviceClass.PortableStorageDevice)` - this story enhances it with filtering

### Current Implementation State

**Source:** [src/UsbDeviceInspector/Services/DeviceEnumerationService.cs]

```csharp
public async Task<IEnumerable<DeviceInformation>> EnumerateDevicesAsync()
{
    Debug.WriteLine("DeviceEnumerationService: Starting USB storage device enumeration...");
    var devices = await DeviceInformation.FindAllAsync(DeviceClass.PortableStorageDevice);
    Debug.WriteLine($"DeviceEnumerationService: Enumeration complete. Found {devices.Count} device(s).");
    return devices.ToList();
}
```

This method needs to be enhanced to filter out non-USB devices after enumeration.

### Architecture References

#### DeviceEnumerationService Component Specification

**Source:** [architecture/components.md#deviceenumerationservice]

- **Responsibility:** Discovers connected USB storage devices using Windows.Devices.Enumeration API and returns raw DeviceInformation objects for parsing
- **Key Interface:** `string GetDeviceSelector()` - Returns AQS (Advanced Query Syntax) filter string to exclude internal SD card readers and non-USB devices
- **Technology Stack:** Uses `DeviceInformation.FindAllAsync()` with `DeviceClass.PortableStorageDevice` selector

#### Device Instance Path Format

**Source:** [architecture/components.md#deviceparsingservice]

Device Instance Path pattern for USB devices: `USB\VID_xxxx&PID_xxxx\<serial>`

Examples of Device Instance Paths:
- **USB Flash Drive:** `USB\VID_0781&PID_5581\4C530001231120115142` (should INCLUDE)
- **Internal SD Card:** `SD\DISK&VEN_&PROD_SD\...` or `PCI\...\SD...` (should EXCLUDE)
- **Internal SSD:** `SCSI\DISK&VEN_SAMSUNG&PROD_...` or `NVME\...` (should EXCLUDE)

#### Filtering Strategy

**Source:** [PRD Epic 2.2 AC + architecture/components.md]

1. **AQS Selector:** Use Advanced Query Syntax if possible to pre-filter at the Windows API level
2. **Post-Enumeration Filtering:** For complex rules that AQS cannot express, apply filtering after `FindAllAsync()` returns
3. **Device Instance Path Inspection:** The most reliable way to determine device connection type is inspecting the Device Instance Path prefix:
   - `USB\` = USB-connected device (INCLUDE)
   - `SD\`, `SDBUS\`, `MMC\` = Internal SD/MMC reader (EXCLUDE)
   - `SCSI\`, `SATA\`, `NVME\`, `PCIE\`, `IDE\` = Internal drive (EXCLUDE)

### File Locations

**Source:** [architecture/source-tree.md]

**Files to MODIFY:**

| File | Purpose |
|------|---------|
| `src/UsbDeviceInspector/Services/DeviceEnumerationService.cs` | Add filtering methods |
| `src/UsbDeviceInspector/Services/Interfaces/IDeviceEnumerationService.cs` | Add `GetDeviceSelector()` if needed |

**Files to CREATE:**

| File | Purpose |
|------|---------|
| `src/UsbDeviceInspector.Tests/Services/DeviceEnumerationServiceFilteringTests.cs` | Unit tests for filtering logic |

### Tech Stack Reference

**Source:** [architecture/tech-stack.md]

| Technology | Version | Relevant to this Story |
|------------|---------|------------------------|
| .NET SDK | 8.0.101 | Build tools |
| C# | 12.0 | Language features |
| Windows App SDK | 1.8.250907003 | Windows.Devices.Enumeration API |
| xUnit | 2.6.6 | Unit testing |
| FluentAssertions | 6.12.0 | Test assertions |
| NSubstitute | 5.1.0 | Mocking (for creating mock DeviceInformation) |

### Coding Standards

**Source:** [architecture/coding-standards.md]

**Critical Rules for this Story:**

1. **Async/Await Usage:** All Windows API calls MUST use `async`/`await` - never block with `.Result` or `.Wait()`
2. **Async Method Naming:** All async methods MUST end with `Async` suffix
3. **Naming Conventions:**
   - Classes/Interfaces: PascalCase (`DeviceEnumerationService`)
   - Methods: PascalCase (`GetDeviceSelector`, `IsUsbConnectedDevice`)
   - Private fields: `_camelCase` with underscore prefix
4. **Nullable Reference Types:** Enabled project-wide - handle nullability appropriately
5. **Logging:** Use `Debug.WriteLine` for development logging (MVP phase)
6. **Device Instance Path Parsing:** Validate format before parsing - never assume well-formed input

### Testing

**Source:** [architecture/test-strategy-and-standards.md]

**Test File Location:** `src/UsbDeviceInspector.Tests/Services/DeviceEnumerationServiceFilteringTests.cs`

**Test Framework:** xUnit 2.6.6 with FluentAssertions 6.12.0 and NSubstitute 5.1.0

**Test Method Naming Convention:** `MethodName_Scenario_ExpectedBehavior`

**Test Pattern:** AAA (Arrange, Act, Assert) with clear section comments

**Testing Strategy for Filtering:**
- The filtering methods should be testable with mock `DeviceInformation` objects
- Since `DeviceInformation` is a Windows Runtime type, consider:
  - Making filtering methods accept minimal data (just the Device Instance Path string)
  - Or creating internal/testable overloads that accept raw data
  - Or using NSubstitute to mock `DeviceInformation.Id` property

**Example Test Structure:**
```csharp
[Fact]
public void IsUsbConnectedDevice_WithUsbPrefix_ReturnsTrue()
{
    // Arrange
    var deviceInstancePath = @"USB\VID_0781&PID_5581\4C530001231120115142";

    // Act
    var result = DeviceEnumerationService.IsUsbDevicePath(deviceInstancePath);

    // Assert
    result.Should().BeTrue();
}

[Fact]
public void IsUsbConnectedDevice_WithSdPrefix_ReturnsFalse()
{
    // Arrange
    var deviceInstancePath = @"SD\DISK&VEN_&PROD_SD_CARD\...";

    // Act
    var result = DeviceEnumerationService.IsUsbDevicePath(deviceInstancePath);

    // Assert
    result.Should().BeFalse();
}
```

**Note:** Consider making filter methods `internal` with `[InternalsVisibleTo]` attribute or creating static helper methods that accept strings for easier unit testing without Windows API mocking.

### Windows API Notes

**Source:** [Windows.Devices.Enumeration documentation]

**DeviceInformation Properties:**
- `Id` - The device instance path (e.g., `USB\VID_0781&PID_5581\serial`)
- `Name` - Friendly device name
- `Properties` - Dictionary of additional device properties

**Getting Device Instance Path:**
```csharp
// The Id property IS the Device Instance Path
string deviceInstancePath = deviceInfo.Id;
```

**AQS Filter Examples:**
```csharp
// Filter for USB devices (example - actual syntax may vary)
string selector = "System.Devices.InterfaceClassGuid:=\"{...}\" AND System.Devices.DeviceInstanceId:~\"USB\\\"";

// Or use DeviceClass with post-filtering
var devices = await DeviceInformation.FindAllAsync(DeviceClass.PortableStorageDevice);
var usbOnly = devices.Where(d => d.Id.StartsWith("USB\\", StringComparison.OrdinalIgnoreCase));
```

## Change Log

| Date | Version | Description | Author |
|------|---------|-------------|--------|
| 2026-01-20 | 1.0 | Initial story creation | Bob (Scrum Master) |

---

## Dev Agent Record

### Agent Model Used

Claude Opus 4.5 (claude-opus-4-5-20251101)

### File List

**Modified:**
- `src/UsbDeviceInspector/Services/DeviceEnumerationService.cs` - Added filtering methods and updated EnumerateDevicesAsync

**Created:**
- `src/UsbDeviceInspector.Tests/Services/DeviceEnumerationServiceFilteringTests.cs` - 21 unit tests for filtering logic

### Completion Notes

- Implemented device filtering using post-enumeration approach (AQS alone cannot express SD/MMC exclusion rules)
- Created static helper methods (`IsUsbDevicePath`, `IsInternalSdCardReaderPath`) that accept strings for easy unit testing
- `FilterUsbStorageDevices` method applies both USB verification and SD/MMC exclusion
- Debug.WriteLine logging shows original vs filtered device counts
- All 24 unit tests passing (21 new filtering tests + 3 existing)
- Build: 0 errors, 0 warnings
- **Manual validation (AC6):** Cannot complete in current environment - WinUI3 runtime not available (DLL load error). Manual testing with physical devices required on Windows machine with Windows App SDK installed.

### Debug Log References

Debug output format added to `EnumerateDevicesAsync`:
```
DeviceEnumerationService: Starting USB storage device enumeration...
DeviceEnumerationService: Enumeration complete. Found {N} device(s) before filtering.
DeviceEnumerationService: Filtering complete. {M} USB storage device(s) after filtering (excluded {N-M}).
```

### Post-Implementation Bug Fixes (Story 2.7 Context)

During Story 2.7 implementation and user testing, two critical bugs were discovered and fixed:

**Bug Fix #1: Missing WPD Layer Support**
- **Issue:** `IsUsbDevicePath` only checked for `USB\` prefix, missing WPD-enumerated USB storage devices
- **Symptom:** Real USB devices enumerated via Windows Portable Device (WPD) layer showed as `SWD\WPDBUSENUM\..._USBSTOR_...` and were incorrectly filtered out
- **Fix:** Extended `IsUsbDevicePath` to accept paths starting with `SWD\WPDBUSENUM\` that contain `USBSTOR` pattern
- **Code Change:**
  ```csharp
  // Accept WPD-enumerated USB storage
  if (deviceInstancePath.StartsWith("SWD\\WPDBUSENUM\\", StringComparison.OrdinalIgnoreCase) &&
      deviceInstancePath.Contains("USBSTOR", StringComparison.OrdinalIgnoreCase))
      return true;
  ```

**Bug Fix #2: Incorrect Property Used for Filtering**
- **Issue:** `FilterUsbStorageDevices` used `device.Id` (GUID interface string) instead of `System.Devices.DeviceInstanceId` property
- **Symptom:** Filter logic received GUID strings instead of device instance paths, causing USB devices to be incorrectly filtered out
- **Fix:** Changed filter to use `GetPropertyValue<string>(device, "System.Devices.DeviceInstanceId")`
- **Code Change:**
  ```csharp
  // OLD: var deviceInstancePath = device.Id;
  // NEW: Use DeviceInstanceId property, not device.Id
  var deviceInstancePath = GetPropertyValue<string>(device, "System.Devices.DeviceInstanceId");
  ```

**Validation:**
- Created debug tool `src/UsbDebugTool/` to enumerate devices and inspect paths
- User confirmed fixes resolved "0 devices found" issue with physical USB stick
- App now correctly detects and displays WPD-enumerated USB storage devices

### Story DoD Checklist

**1. Requirements Met:**
- [x] All functional requirements specified in the story are implemented
  - AC1: GetDeviceSelector() method created
  - AC2: IsInternalSdCardReaderPath() filters SD/MMC patterns
  - AC3: IsUsbDevicePath() verifies USB connection, excludes SATA/PCIE/NVME/IDE
  - AC4: FilterUsbStorageDevices() combines both filters
  - AC5: 21 unit tests cover all filtering scenarios
  - AC7: Debug.WriteLine shows filtered count
- [x] All acceptance criteria defined in the story are met (AC6 manual validation blocked by environment)

**2. Coding Standards & Project Structure:**
- [x] Code adheres to Operational Guidelines (async/await, naming conventions)
- [x] Code aligns with Project Structure (Services folder, test mirrors)
- [x] Adherence to Tech Stack (.NET 8, C# 12, xUnit, FluentAssertions)
- [N/A] Api Reference / Data Models - no API or data model changes
- [x] Security best practices (null checks, input validation)
- [x] No new linter errors or warnings (0 warnings build)
- [x] Code well-commented with XML documentation

**3. Testing:**
- [x] All required unit tests implemented (21 new tests)
- [N/A] Integration tests - not required for this story
- [x] All tests pass (24/24)
- [x] Test coverage meets standards (all filtering paths covered)

**4. Functionality & Verification:**
- [ ] Manual verification - BLOCKED: WinUI3 runtime not available in environment
- [x] Edge cases handled (null, empty, case-insensitive, unknown prefixes)

**5. Story Administration:**
- [x] All code implementation tasks marked complete
- [ ] Manual validation task incomplete (environment limitation)
- [x] Decisions documented (post-enumeration filtering approach)
- [x] Story wrap-up completed with agent model and changelog

**6. Dependencies, Build & Configuration:**
- [x] Project builds successfully (0 errors, 0 warnings)
- [x] Linting passes
- [x] No new dependencies added
- [N/A] No new environment variables

**7. Documentation:**
- [x] Inline XML documentation complete for all public APIs
- [N/A] No user-facing documentation changes needed
- [N/A] No architectural changes requiring diagram updates

**Final Confirmation:**
- [ ] **BLOCKED FOR REVIEW** - Manual validation (AC6) cannot be completed in current environment. All other DoD items complete. Story requires manual testing with physical USB devices on a Windows machine with Windows App SDK installed before final approval.